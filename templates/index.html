<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Protein Resequencer</title>
    <link href="https://fonts.googleapis.com/css2?family=Antonio:wght@400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --lcars-orange: #ff9900; --lcars-yellow: #ffcc00; --lcars-blue: #9999ff; --lcars-purple: #cc99cc; --lcars-red: #cc4444; --lcars-tan: #ffaa66; --lcars-lavender: #9977aa; --bg-primary: #000; --bg-secondary: #0a0a12; --text-light: #ffcc99; --success: #55cc55; --danger: #cc4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { font-family: 'Antonio', sans-serif; background: var(--bg-primary); color: var(--lcars-orange); height: 100vh; width: 100vw; overflow: hidden; font-size: 18px; }
        .app { display: grid; grid-template-rows: 48px 1fr 58px; height: 100vh; }
        .header { display: flex; align-items: center; padding: 0 10px; gap: 10px; background: linear-gradient(90deg, var(--lcars-purple) 0%, var(--lcars-purple) 50%, transparent 50%); }
        .header-title { font-family: 'Orbitron', sans-serif; font-size: 18px; color: var(--bg-primary); text-transform: uppercase; letter-spacing: 2px; flex: 1; padding-left: 10px; }
        .header-status { background: var(--lcars-tan); padding: 8px 16px; border-radius: 15px; font-family: 'Orbitron', sans-serif; font-size: 16px; color: var(--bg-primary); text-transform: uppercase; }
        .header-status.fermenting { background: var(--success); animation: pulse 2s infinite; }
        .btn-quit { background: var(--danger); border: none; width: 48px; height: 48px; border-radius: 8px; font-size: 24px; color: white; cursor: pointer; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px var(--lcars-orange); } 50% { box-shadow: 0 0 20px var(--lcars-orange); } }
        @keyframes dataStream { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        @keyframes blink { 0%, 50%, 100% { opacity: 1; } 25%, 75% { opacity: 0.3; } }
        @keyframes pressDown { 0% { transform: scale(1); } 50% { transform: scale(0.95); } 100% { transform: scale(1); } }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes tempPulse { 0%, 100% { color: var(--lcars-yellow); } 50% { color: var(--lcars-orange); } }
        .nav { display: flex; gap: 4px; padding: 6px 10px; background: var(--bg-secondary); }
        .nav-btn { flex: 1; background: var(--lcars-tan); border: none; padding: 12px 6px; font-family: 'Orbitron', sans-serif; font-size: 16px; color: var(--bg-primary); text-transform: uppercase; border-radius: 8px; cursor: pointer; }
        .nav-btn:active { animation: pressDown 0.2s ease; }
        .nav-btn.active { background: var(--lcars-orange); }
        .nav-btn.blue { background: var(--lcars-blue); }
        .nav-btn.purple { background: var(--lcars-purple); }
        .main { overflow: hidden; position: relative; }
        .screen { position: absolute; inset: 0; padding: 8px; display: none; flex-direction: column; overflow-y: auto; }
        .screen.active { display: flex; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 6px; flex: 1; }
        .panel { background: rgba(255, 153, 0, 0.05); border: 2px solid var(--lcars-orange); border-radius: 0 12px 12px 0; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .panel::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--lcars-yellow), transparent); animation: dataStream 2s linear infinite; background-size: 200% 100%; }
        .panel-header { background: var(--lcars-orange); padding: 5px 10px; display: flex; justify-content: space-between; align-items: center; }
        .panel-title { font-family: 'Orbitron', sans-serif; font-size: 14px; color: var(--bg-primary); text-transform: uppercase; }
        .panel-indicator { width: 12px; height: 12px; border-radius: 50%; }
        .panel-indicator.off { background: var(--lcars-tan); }
        .panel-indicator.on { background: var(--success); animation: blink 1s infinite; }
        .panel-content { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 8px; }
        .temp-display { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .temp-main { font-family: 'Orbitron', sans-serif; font-size: 32px; font-weight: 700; color: var(--lcars-yellow); animation: tempPulse 3s ease infinite; }
        .temp-unit { font-size: 18px; color: var(--lcars-orange); }
        .temp-sensors { display: flex; gap: 6px; margin-top: 6px; }
        .temp-sensor { display: flex; flex-direction: column; align-items: center; padding: 3px 6px; background: rgba(153, 153, 255, 0.1); border: 1px solid var(--lcars-blue); border-radius: 4px; }
        .temp-sensor-label { font-size: 10px; color: var(--lcars-blue); }
        .temp-sensor-value { font-family: 'Orbitron', sans-serif; font-size: 13px; color: var(--lcars-yellow); }
        .stat-value { font-family: 'Orbitron', sans-serif; font-size: 36px; font-weight: 700; color: var(--lcars-yellow); }
        .stat-unit { font-size: 18px; color: var(--lcars-orange); }
        .stat-target { font-size: 14px; color: var(--lcars-tan); margin-top: 4px; }
        .batch-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; width: 100%; }
        .batch-label { color: var(--lcars-tan); font-size: 11px; text-transform: uppercase; }
        .batch-value { color: var(--lcars-yellow); font-family: 'Orbitron', sans-serif; font-size: 13px; }
        .progress-bar { width: 100%; height: 8px; background: rgba(255, 153, 0, 0.2); border-radius: 4px; margin-top: 6px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--lcars-orange), var(--lcars-yellow)); }
        .actuators-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; width: 100%; }
        .actuator { display: flex; flex-direction: column; align-items: center; padding: 4px; cursor: pointer; border-radius: 4px; border: 1px solid transparent; }
        .actuator.on { border-color: var(--success); background: rgba(85, 204, 85, 0.1); }
        .actuator-led { font-size: 18px; }
        .actuator-led.on { color: var(--success); text-shadow: 0 0 10px var(--success); }
        .actuator-led.off { color: var(--lcars-tan); }
        .actuator-name { font-size: 10px; color: var(--lcars-tan); text-transform: uppercase; }
        .empty-state { display: flex; flex-direction: column; justify-content: center; align-items: center; grid-column: span 2; grid-row: span 2; }
        .empty-icon { width: 100px; height: 100px; border: 3px solid var(--lcars-orange); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 48px; color: var(--lcars-orange); margin-bottom: 16px; cursor: pointer; animation: glow 2s ease infinite; }
        .empty-title { font-family: 'Orbitron', sans-serif; font-size: 18px; color: var(--lcars-tan); text-transform: uppercase; }
        .preset-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 8px; }
        .preset-card { background: rgba(255, 170, 102, 0.1); border: 2px solid var(--lcars-tan); border-radius: 8px; padding: 8px 4px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; min-height: 65px; }
        .preset-card:active { animation: pressDown 0.2s ease; }
        .preset-card.selected { background: rgba(255, 153, 0, 0.3); border-color: var(--lcars-orange); box-shadow: 0 0 10px rgba(255, 153, 0, 0.5); }
        .preset-card.custom { border-color: var(--lcars-purple); }
        .preset-card.manual { grid-column: span 4; flex-direction: row; justify-content: center; gap: 12px; min-height: 45px; }
        .preset-icon { font-size: 22px; }
        .preset-name { font-family: 'Orbitron', sans-serif; font-size: 11px; color: var(--lcars-yellow); text-transform: uppercase; }
        .form-section { background: rgba(255, 153, 0, 0.05); border: 2px solid var(--lcars-orange); border-radius: 0 8px 8px 0; padding: 8px; margin-bottom: 8px; }
        .section-title { font-family: 'Orbitron', sans-serif; font-size: 14px; color: var(--lcars-orange); text-transform: uppercase; margin-bottom: 6px; }
        .form-input { width: 100%; padding: 10px; background: var(--bg-secondary); border: 2px solid var(--lcars-tan); border-radius: 4px; color: var(--lcars-yellow); font-family: 'Antonio', sans-serif; font-size: 18px; }
        .form-input:focus { outline: none; border-color: var(--lcars-orange); }
        .form-textarea { width: 100%; min-height: 80px; padding: 10px; background: var(--bg-secondary); border: 2px solid var(--lcars-tan); border-radius: 4px; color: var(--lcars-yellow); font-family: 'Antonio', sans-serif; font-size: 18px; resize: none; }
        .steps-list { flex: 1; overflow-y: auto; margin-bottom: 8px; }
        .step-card { background: rgba(153, 153, 255, 0.1); border: 1px solid var(--lcars-blue); border-radius: 6px; margin-bottom: 6px; }
        .step-header { background: var(--lcars-blue); padding: 4px 8px; display: flex; justify-content: space-between; align-items: center; }
        .step-title { font-family: 'Orbitron', sans-serif; font-size: 12px; color: var(--bg-primary); }
        .step-delete { background: var(--danger); border: none; color: white; font-size: 14px; cursor: pointer; padding: 2px 8px; border-radius: 4px; }
        .step-content { padding: 6px; display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        .step-content .form-input { padding: 6px; font-size: 16px; }
        .form-label { font-size: 11px; color: var(--lcars-tan); text-transform: uppercase; }
        .btn-large { background: var(--success); border: none; padding: 14px; font-family: 'Orbitron', sans-serif; font-size: 18px; color: var(--bg-primary); text-transform: uppercase; border-radius: 8px; cursor: pointer; }
        .btn-small { background: var(--lcars-tan); border: none; padding: 8px 12px; font-family: 'Orbitron', sans-serif; font-size: 12px; color: var(--bg-primary); text-transform: uppercase; border-radius: 6px; cursor: pointer; }
        .events-list, .history-list { flex: 1; overflow-y: auto; }
        .event-item { background: rgba(255, 153, 0, 0.05); border-left: 4px solid var(--lcars-orange); padding: 8px; margin-bottom: 4px; border-radius: 0 6px 6px 0; }
        .event-time { font-family: 'Orbitron', sans-serif; font-size: 11px; color: var(--lcars-tan); }
        .event-text { color: var(--lcars-yellow); font-size: 14px; }
        .history-item { background: rgba(255, 153, 0, 0.05); border: 1px solid var(--lcars-orange); border-radius: 6px; margin-bottom: 6px; }
        .history-header { background: var(--lcars-tan); padding: 6px 8px; display: flex; justify-content: space-between; align-items: center; }
        .history-title { font-family: 'Orbitron', sans-serif; font-size: 12px; color: var(--bg-primary); }
        .history-badge { background: var(--success); color: var(--bg-primary); padding: 2px 6px; border-radius: 4px; font-size: 10px; }
        .history-badge.failed { background: var(--danger); }
        .history-content { padding: 6px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
        .history-label { font-size: 10px; color: var(--lcars-tan); text-transform: uppercase; }
        .history-value { font-family: 'Orbitron', sans-serif; font-size: 12px; color: var(--lcars-yellow); }
        .history-actions { display: flex; gap: 4px; padding: 6px; }
        .history-actions .btn-small { flex: 1; text-align: center; font-size: 11px; }
        .modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 16px; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-secondary); border: 2px solid var(--lcars-orange); border-radius: 0 16px 16px 0; padding: 16px; width: 100%; max-width: 400px; }
        .modal-title { font-family: 'Orbitron', sans-serif; font-size: 16px; color: var(--lcars-orange); text-transform: uppercase; margin-bottom: 12px; text-align: center; }
        .modal-buttons { display: flex; gap: 8px; margin-top: 16px; }
        .modal-buttons .btn-small { flex: 1; padding: 12px; font-size: 14px; }
        .modal-cancel { background: var(--lcars-lavender); }
        .modal-confirm { background: var(--lcars-orange); }
        .stars { display: flex; gap: 8px; justify-content: center; margin: 12px 0; }
        .star { font-size: 28px; color: var(--lcars-tan); cursor: pointer; }
        .star.active { color: var(--lcars-yellow); text-shadow: 0 0 10px var(--lcars-yellow); }
        .status-buttons { display: flex; gap: 8px; margin: 12px 0; }
        .status-btn { flex: 1; background: var(--lcars-tan); border: none; padding: 10px; font-family: 'Orbitron', sans-serif; font-size: 14px; color: var(--bg-primary); border-radius: 6px; cursor: pointer; opacity: 0.5; }
        .status-btn.active { opacity: 1; }
        .status-btn.success { background: var(--success); }
        .status-btn.danger { background: var(--danger); }
        .alert-container { position: fixed; top: 56px; right: 8px; z-index: 1001; }
        .alert { background: var(--success); color: var(--bg-primary); padding: 10px 14px; border-radius: 6px; margin-bottom: 6px; font-family: 'Orbitron', sans-serif; font-size: 12px; animation: slideIn 0.3s ease; }
        .alert.error { background: var(--danger); }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <div class="header-title" id="pageTitle">Accueil</div>
            <div class="header-status" id="headerStatus">Inactif</div>
            <button class="btn-quit" onclick="quitApp()">×</button>
        </div>
        <div class="main">
            <div class="screen active" id="dashboard"><div class="dashboard-grid" id="dashboardContent"></div></div>
            <div class="screen" id="create">
                <div class="form-section"><div class="section-title">Nom du batch</div><input type="text" class="form-input" id="batchName" placeholder="Mon batch" inputmode="text"></div>
                <div class="form-section"><div class="section-title">Préréglage</div><div id="presetGrid" class="preset-grid"></div></div>
                <div class="form-section" style="flex:1;display:flex;flex-direction:column;"><div style="display:flex;justify-content:space-between;align-items:center;"><div class="section-title">Étapes</div><button class="btn-small" onclick="addStep()">+ Ajouter</button></div><div class="steps-list" id="stepsList"></div></div>
                <button class="btn-large" onclick="startBatch()">Démarrer</button>
            </div>
            <div class="screen" id="events"><button class="btn-large" onclick="openModal('eventModal')" style="background:var(--lcars-orange);margin-bottom:12px;">+ Ajouter note</button><div class="events-list" id="eventsList"></div></div>
            <div class="screen" id="history"><div class="section-title" style="margin-bottom:8px;">Historique</div><div class="history-list" id="historyList"></div></div>
        </div>
        <div class="nav">
            <button class="nav-btn active" data-screen="dashboard" onclick="showScreen('dashboard')">Accueil</button>
            <button class="nav-btn" data-screen="create" onclick="showScreen('create')">Nouveau</button>
            <button class="nav-btn blue" data-screen="events" onclick="showScreen('events')">Notes</button>
            <button class="nav-btn purple" data-screen="history" onclick="showScreen('history')">Historique</button>
        </div>
    </div>
    <div class="alert-container" id="alertContainer"></div>
    <div class="modal" id="eventModal"><div class="modal-content"><div class="modal-title">Ajouter note</div><textarea class="form-textarea" id="eventInput" placeholder="Observation..." inputmode="text"></textarea><div class="modal-buttons"><button class="btn-small modal-cancel" onclick="closeModal('eventModal')">Annuler</button><button class="btn-small modal-confirm" onclick="addEvent()">Ajouter</button></div></div></div>
    <div class="modal" id="stopModal"><div class="modal-content"><div class="modal-title">Terminer</div><div class="form-label" style="text-align:center;">Statut</div><div class="status-buttons"><button class="btn-small status-btn success active" id="statusOk" onclick="setStopStatus('completed')">Réussi</button><button class="btn-small status-btn danger" id="statusFailed" onclick="setStopStatus('failed')">Échoué</button></div><div class="form-label" style="text-align:center;">Note</div><div class="stars" id="stopStars"><span class="star" onclick="setStopRating(1)">★</span><span class="star" onclick="setStopRating(2)">★</span><span class="star" onclick="setStopRating(3)">★</span><span class="star" onclick="setStopRating(4)">★</span><span class="star" onclick="setStopRating(5)">★</span></div><textarea class="form-textarea" id="stopNotes" placeholder="Notes..." inputmode="text"></textarea><div class="modal-buttons"><button class="btn-small modal-cancel" onclick="closeModal('stopModal')">Annuler</button><button class="btn-small" style="background:var(--danger);" onclick="stopBatch()">Terminer</button></div></div></div>
    <div class="modal" id="historyDetailModal"><div class="modal-content"><div class="modal-title" id="historyDetailTitle">Détails</div><div id="historyDetailContent"></div></div></div>
    <div class="modal" id="confirmDeleteModal"><div class="modal-content"><div class="modal-title">Confirmer</div><p style="color:var(--lcars-yellow);text-align:center;margin:16px 0;">Supprimer ce batch ?</p><div class="modal-buttons"><button class="btn-small modal-cancel" onclick="closeModal('confirmDeleteModal')">Annuler</button><button class="btn-small" style="background:var(--danger);" onclick="confirmDeleteHistory()">Supprimer</button></div></div></div>
    <script>
        const ICONS={natto:'N',tempeh:'T',koji_rice:'KR',kombucha:'KB',yogurt:'Y',kimchi:'KI',lacto:'LF',miso:'MI',vinegar:'V',dehydrate:'DH',manual:'M'};
        let state={},presets={},selectedPreset=null,editSteps=[],stopStatus='completed',stopRating=0,historyToDelete=null;
        function setStopStatus(s){stopStatus=s;document.querySelectorAll('.status-btn').forEach(b=>b.classList.remove('active'));document.getElementById(s==='completed'?'statusOk':'statusFailed').classList.add('active');}
        function setStopRating(r){stopRating=r;document.querySelectorAll('#stopStars .star').forEach((s,i)=>s.classList.toggle('active',i<r));}
        async function fetchState(){try{state=await(await fetch('/api/state')).json();document.getElementById('headerStatus').textContent=state.batch?'En cours':'Inactif';document.getElementById('headerStatus').className='header-status'+(state.batch?' fermenting':'');renderDashboard();}catch(e){}}
        async function fetchPresets(){try{presets=await(await fetch('/api/presets')).json();renderPresets();}catch(e){}}
        async function fetchHistory(){try{renderHistory(await(await fetch('/api/history')).json());}catch(e){}}
        function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));document.querySelector('[data-screen="'+id+'"]')?.classList.add('active');document.getElementById('pageTitle').textContent={dashboard:'Accueil',create:'Nouveau',events:'Notes',history:'Historique'}[id];if(id==='history')fetchHistory();if(id==='events')renderEvents();}
        function renderDashboard(){const c=document.getElementById('dashboardContent');if(!state.batch){c.innerHTML='<div class="empty-state"><div class="empty-icon" onclick="showScreen(\'create\')">+</div><h2 class="empty-title">Aucune fermentation</h2></div>';return;}const t=state.sensors.temperature||[0,0,0],avg=(t.reduce((a,b)=>a+b,0)/t.length).toFixed(1),s=state.batch.current_step,p=state.batch.step_progress||0,e=state.batch.elapsed_hours||0;c.innerHTML='<div class="panel"><div class="panel-header"><span class="panel-title">Température</span><div class="panel-indicator '+(state.actuators.heater?'on':'off')+'"></div></div><div class="panel-content"><div class="temp-display"><div class="temp-main">'+avg+'<span class="temp-unit">°C</span></div><div class="temp-sensors"><div class="temp-sensor"><span class="temp-sensor-label">T1</span><span class="temp-sensor-value">'+t[0].toFixed(1)+'°</span></div><div class="temp-sensor"><span class="temp-sensor-label">T2</span><span class="temp-sensor-value">'+t[1].toFixed(1)+'°</span></div><div class="temp-sensor"><span class="temp-sensor-label">T3</span><span class="temp-sensor-value">'+t[2].toFixed(1)+'°</span></div></div><div class="stat-target">Cible: '+s.temp+'°C</div></div></div></div><div class="panel"><div class="panel-header"><span class="panel-title">Humidité</span><div class="panel-indicator '+(state.actuators.humidifier?'on':'off')+'"></div></div><div class="panel-content"><span class="stat-value">'+state.sensors.humidity.toFixed(0)+'<span class="stat-unit">%</span></span><div class="stat-target">Cible: '+s.humidity+'%</div></div></div><div class="panel"><div class="panel-header"><span class="panel-title">'+state.batch.name+'</span></div><div class="panel-content"><div class="batch-grid"><div><span class="batch-label">Étape</span><div class="batch-value">'+(state.batch.current_step_index+1)+'/'+state.batch.steps.length+'</div></div><div><span class="batch-label">Phase</span><div class="batch-value">'+s.name+'</div></div><div><span class="batch-label">Temps</span><div class="batch-value">'+e.toFixed(1)+'h</div></div><div><span class="batch-label">Durée</span><div class="batch-value">'+s.duration+'h</div></div></div><div class="progress-bar"><div class="progress-fill" style="width:'+p+'%"></div></div></div></div><div class="panel"><div class="panel-header"><span class="panel-title">Contrôle</span></div><div class="panel-content"><div class="actuators-grid"><div class="actuator '+(state.actuators.heater?'on':'')+'" onclick="toggleActuator(\'heater\')"><div class="actuator-led '+(state.actuators.heater?'on':'off')+'">●</div><span class="actuator-name">Chauffe</span></div><div class="actuator '+(state.actuators.humidifier?'on':'')+'" onclick="toggleActuator(\'humidifier\')"><div class="actuator-led '+(state.actuators.humidifier?'on':'off')+'">●</div><span class="actuator-name">Humid.</span></div><div class="actuator '+(state.actuators.fan_internal?'on':'')+'" onclick="toggleActuator(\'fan_internal\')"><div class="actuator-led '+(state.actuators.fan_internal?'on':'off')+'">●</div><span class="actuator-name">Ventilo</span></div><div class="actuator '+(state.actuators.fan_extract?'on':'')+'" onclick="toggleActuator(\'fan_extract\')"><div class="actuator-led '+(state.actuators.fan_extract?'on':'off')+'">●</div><span class="actuator-name">Extract.</span></div></div><div style="display:flex;gap:4px;margin-top:6px;width:100%;">'+(state.batch.current_step_index<state.batch.steps.length-1?'<button class="btn-small" style="flex:1" onclick="nextStep()">Étape suiv.</button>':'')+'<button class="btn-small" style="flex:1;background:var(--danger);" onclick="openStopModal()">Terminer</button></div></div></div>';}
        function renderPresets(){const g=document.getElementById('presetGrid'),sys=Object.entries(presets).filter(([k,p])=>p.system!==false&&k!=='manual'),cust=Object.entries(presets).filter(([k,p])=>p.system===false),man=presets.manual;g.innerHTML=sys.map(([k,p])=>'<div class="preset-card '+(selectedPreset===k?'selected':'')+'" onclick="selectPreset(\''+k+'\')"><div class="preset-icon">'+(ICONS[k]||'?')+'</div><div class="preset-name">'+p.name+'</div></div>').join('')+cust.map(([k,p])=>'<div class="preset-card custom '+(selectedPreset===k?'selected':'')+'" onclick="selectPreset(\''+k+'\')"><div class="preset-icon">C</div><div class="preset-name">'+p.name+'</div></div>').join('')+(man?'<div class="preset-card manual '+(selectedPreset==='manual'?'selected':'')+'" onclick="selectPreset(\'manual\')"><div class="preset-icon">M</div><div class="preset-name">'+man.name+'</div></div>':'');}
        function selectPreset(k){selectedPreset=k;editSteps=JSON.parse(JSON.stringify(presets[k].steps));document.getElementById('batchName').value=presets[k].name;renderPresets();renderSteps();}
        function renderSteps(){document.getElementById('stepsList').innerHTML=editSteps.map((s,i)=>'<div class="step-card"><div class="step-header"><span class="step-title">Étape '+(i+1)+'</span><button class="step-delete" onclick="deleteStep('+i+')">×</button></div><div class="step-content"><div><label class="form-label">Nom</label><input type="text" class="form-input" value="'+s.name+'" onchange="editSteps['+i+'].name=this.value" inputmode="text"></div><div><label class="form-label">Temp °C</label><input type="number" class="form-input" value="'+s.temp+'" onchange="editSteps['+i+'].temp=+this.value" inputmode="numeric"></div><div><label class="form-label">Humid %</label><input type="number" class="form-input" value="'+s.humidity+'" onchange="editSteps['+i+'].humidity=+this.value" inputmode="numeric"></div><div><label class="form-label">Durée h</label><input type="number" class="form-input" value="'+s.duration+'" onchange="editSteps['+i+'].duration=+this.value" inputmode="numeric"></div></div></div>').join('');}
        function deleteStep(i){editSteps.splice(i,1);renderSteps();}
        function addStep(){editSteps.push({name:'Nouvelle',temp:30,humidity:70,duration:12,ventilation:'off'});renderSteps();}
        async function startBatch(){if(!editSteps.length){showAlert('Erreur','Ajoutez une étape',true);return;}const name=document.getElementById('batchName').value||'Sans nom';const res=await fetch('/api/batch/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({preset:selectedPreset,name,steps:editSteps,code:presets[selectedPreset]?.code||'X'})});const data=await res.json();if(data.success){showAlert('Démarré',data.batch.id);fetchState();showScreen('dashboard');}}
        function openStopModal(){stopStatus='completed';stopRating=0;document.querySelectorAll('.status-btn').forEach(b=>b.classList.remove('active'));document.getElementById('statusOk').classList.add('active');document.querySelectorAll('#stopStars .star').forEach(s=>s.classList.remove('active'));document.getElementById('stopNotes').value='';openModal('stopModal');}
        async function stopBatch(){closeModal('stopModal');await fetch('/api/batch/stop',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:stopStatus,rating:stopRating,notes:document.getElementById('stopNotes').value})});showAlert('Terminé','');fetchState();}
        async function nextStep(){const res=await fetch('/api/batch/next-step',{method:'POST'});const data=await res.json();if(data.success){showAlert('Étape suivante',data.step.name);fetchState();}}
        async function toggleActuator(n){await fetch('/api/actuator/'+n,{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'});fetchState();}
        async function addEvent(){const i=document.getElementById('eventInput');if(!i.value)return;await fetch('/api/batch/event',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:i.value})});i.value='';closeModal('eventModal');fetchState();renderEvents();}
        function renderEvents(){const l=document.getElementById('eventsList'),ev=state.events||[];l.innerHTML=ev.length?ev.map(e=>'<div class="event-item"><div class="event-time">'+new Date(e.time).toLocaleString('fr-FR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})+'</div><div class="event-text">'+e.text+'</div></div>').join(''):'<p style="color:var(--lcars-tan);text-align:center;padding:40px;">Aucune note</p>';}
        function renderHistory(h){const l=document.getElementById('historyList');l.innerHTML=h.length?h.slice(0,20).map(b=>'<div class="history-item"><div class="history-header"><span class="history-title">'+b.id+' — '+b.name+'</span><span class="history-badge '+(b.status==='completed'?'':'failed')+'">'+(b.rating?'★'.repeat(b.rating):(b.status==='completed'?'OK':'✗'))+'</span></div><div class="history-content"><div style="text-align:center"><span class="history-label">Date</span><div class="history-value">'+new Date(b.started_at).toLocaleDateString('fr-FR')+'</div></div><div style="text-align:center"><span class="history-label">Durée</span><div class="history-value">'+b.total_duration+'h</div></div><div style="text-align:center"><span class="history-label">Étapes</span><div class="history-value">'+(b.steps?.length||0)+'</div></div><div style="text-align:center"><span class="history-label">Notes</span><div class="history-value">'+(b.events||[]).length+'</div></div></div><div class="history-actions"><button class="btn-small" onclick="relaunchBatch(\''+b.id+'\')">Relancer</button><button class="btn-small" style="background:var(--lcars-purple)" onclick="viewDetail(\''+b.id+'\')">Détails</button><button class="btn-small" style="background:var(--danger)" onclick="deleteHistory(\''+b.id+'\')">Suppr.</button></div></div>').join(''):'<p style="color:var(--lcars-tan);text-align:center;padding:40px;">Aucun historique</p>';}
        async function relaunchBatch(id){const b=await(await fetch('/api/history/'+encodeURIComponent(id))).json();if(b.steps){editSteps=JSON.parse(JSON.stringify(b.steps));document.getElementById('batchName').value=b.name;selectedPreset=b.preset;renderPresets();renderSteps();showScreen('create');showAlert('Chargé','');}}
        async function viewDetail(id){const b=await(await fetch('/api/history/'+encodeURIComponent(id))).json();document.getElementById('historyDetailTitle').textContent=b.id;document.getElementById('historyDetailContent').innerHTML='<p style="color:var(--lcars-tan);font-size:12px">NOM</p><p style="color:var(--lcars-yellow);margin-bottom:10px;">'+b.name+'</p><p style="color:var(--lcars-tan);font-size:12px">ÉTAPES</p>'+b.steps.map((s,i)=>'<p style="color:var(--lcars-blue);font-size:14px">'+(i+1)+'. '+s.name+' — '+s.temp+'°C, '+s.humidity+'%, '+s.duration+'h</p>').join('')+(b.notes?'<p style="color:var(--lcars-tan);font-size:12px;margin-top:10px">NOTES</p><p style="color:var(--text-light);">'+b.notes+'</p>':'')+'<div class="modal-buttons"><button class="btn-small modal-cancel" onclick="closeModal(\'historyDetailModal\')">Fermer</button><button class="btn-small modal-confirm" onclick="closeModal(\'historyDetailModal\');relaunchBatch(\''+b.id+'\')">Relancer</button></div>';openModal('historyDetailModal');}
        function deleteHistory(id){historyToDelete=id;openModal('confirmDeleteModal');}
        async function confirmDeleteHistory(){closeModal('confirmDeleteModal');if(historyToDelete){await fetch('/api/history/'+encodeURIComponent(historyToDelete),{method:'DELETE'});showAlert('Supprimé','');fetchHistory();historyToDelete=null;}}
        function openModal(id){document.getElementById(id).classList.add('active');}
        function closeModal(id){document.getElementById(id).classList.remove('active');}
        function showAlert(t,m,err){const c=document.getElementById('alertContainer'),a=document.createElement('div');a.className='alert'+(err?' error':'');a.innerHTML='<strong>'+t+'</strong> '+m;c.appendChild(a);setTimeout(()=>a.remove(),3000);}
        function quitApp(){if(confirm('Quitter ?')){fetch('/api/quit',{method:'POST'});setTimeout(()=>window.close(),500);}}
        fetchState();fetchPresets();setInterval(fetchState,5000);
    </script>
</body>
</html>
