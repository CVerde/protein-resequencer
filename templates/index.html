<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Protein Resequencer</title>
    <link href="https://fonts.googleapis.com/css2?family=Antonio:wght@400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --lcars-orange: #ff9900; --lcars-yellow: #ffcc00; --lcars-blue: #9999ff; --lcars-purple: #cc99cc; --lcars-red: #cc4444; --lcars-tan: #ffaa66; --lcars-lavender: #9977aa; --bg-primary: #000; --bg-secondary: #0a0a12; --text-light: #ffcc99; --success: #55cc55; --danger: #cc4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { font-family: 'Antonio', sans-serif; background: var(--bg-primary); color: var(--lcars-orange); height: 100vh; width: 100vw; overflow: hidden; font-size: 18px; }
        .app { display: grid; grid-template-rows: 48px 1fr 58px; height: 100vh; }
        
        /* Header */
        .header { display: flex; align-items: center; padding: 0 10px; gap: 10px; background: linear-gradient(90deg, var(--lcars-purple) 0%, var(--lcars-purple) 50%, transparent 50%); }
        .header-title { font-family: 'Orbitron', sans-serif; font-size: 18px; color: var(--bg-primary); text-transform: uppercase; letter-spacing: 2px; flex: 1; padding-left: 10px; }
        .header-status { background: var(--lcars-tan); padding: 8px 16px; border-radius: 15px; font-family: 'Orbitron', sans-serif; font-size: 16px; color: var(--bg-primary); text-transform: uppercase; }
        .header-status.fermenting { background: var(--success); animation: pulse 2s infinite; }
        /* Croix plus haute - même hauteur que la barre header */
        .btn-quit { background: var(--danger); border: none; width: 48px; height: 48px; border-radius: 8px; font-size: 24px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-quit:active { transform: scale(0.9); }
        
        /* Animations */
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.02); } }
        @keyframes bounceIn { 0% { transform: scale(0.9); opacity: 0; } 50% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes pressDown { 0% { transform: scale(1); } 50% { transform: scale(0.92); } 100% { transform: scale(1); } }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
        
        /* Nav - Typo Orbitron comme DASHBOARD */
        .nav { display: flex; gap: 4px; padding: 6px 10px; background: var(--bg-secondary); }
        .nav-btn { flex: 1; background: var(--lcars-tan); border: none; padding: 12px 6px; font-family: 'Orbitron', sans-serif; font-size: 16px; color: var(--bg-primary); text-transform: uppercase; letter-spacing: 1px; border-radius: 8px; cursor: pointer; transition: transform 0.15s ease; font-weight: 500; }
        .nav-btn:active { animation: pressDown 0.2s ease; }
        .nav-btn.active { background: var(--lcars-orange); }
        .nav-btn.blue { background: var(--lcars-blue); }
        .nav-btn.purple { background: var(--lcars-purple); }
        
        /* Main */
        .main { overflow: hidden; position: relative; }
        .screen { position: absolute; inset: 0; padding: 8px; display: none; flex-direction: column; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .screen.active { display: flex; }
        
        /* Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 6px; flex: 1; }
        .panel { background: rgba(255, 153, 0, 0.05); border: 2px solid var(--lcars-orange); border-radius: 0 12px 12px 0; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { background: var(--lcars-orange); padding: 5px 10px; display: flex; justify-content: space-between; align-items: center; }
        .panel-title { font-family: 'Orbitron', sans-serif; font-size: 14px; color: var(--bg-primary); text-transform: uppercase; }
        .panel-indicator { width: 12px; height: 12px; border-radius: 50%; background: var(--success); }
        .panel-indicator.off { background: var(--lcars-tan); }
        .panel-content { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 6px; }
        .stat-value { font-family: 'Orbitron', sans-serif; font-size: 36px; font-weight: 700; color: var(--lcars-yellow); line-height: 1; }
        .stat-unit { font-size: 20px; color: var(--lcars-orange); }
        .stat-target { font-size: 16px; color: var(--lcars-tan); margin-top: 4px; }
        .batch-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; width: 100%; font-size: 14px; }
        .batch-field { display: flex; flex-direction: column; }
        .batch-label { color: var(--lcars-tan); font-size: 12px; text-transform: uppercase; }
        .batch-value { color: var(--lcars-yellow); font-family: 'Orbitron', sans-serif; font-weight: 600; }
        .progress-bar { width: 100%; height: 6px; background: rgba(255, 153, 0, 0.2); border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--lcars-orange); transition: width 0.3s ease; }
        .actuators-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; width: 100%; }
        .actuator { display: flex; flex-direction: column; align-items: center; padding: 4px; cursor: pointer; border-radius: 4px; transition: background 0.2s ease; }
        .actuator:active { background: rgba(255, 153, 0, 0.1); }
        .actuator-led { font-size: 24px; line-height: 1; }
        .actuator-led.on { color: var(--success); }
        .actuator-led.off { color: var(--lcars-tan); }
        .actuator-name { font-size: 12px; color: var(--lcars-tan); text-transform: uppercase; margin-top: 2px; }
        
        /* Empty state avec + cliquable et bien centré */
        .empty-state { display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .empty-icon { width: 80px; height: 80px; border: 3px solid var(--lcars-orange); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 48px; color: var(--lcars-orange); margin-bottom: 16px; cursor: pointer; transition: all 0.3s ease; line-height: 1; font-weight: normal; }
        .empty-icon:hover { background: rgba(255, 153, 0, 0.1); transform: scale(1.05); }
        .empty-icon:active { transform: scale(0.95); }
        .empty-title { font-family: 'Orbitron', sans-serif; font-size: 24px; color: var(--lcars-tan); text-transform: uppercase; letter-spacing: 2px; }
        
        /* Create screen */
        .create-content { display: flex; flex-direction: column; gap: 8px; flex: 1; }
        .form-section { background: rgba(255, 153, 0, 0.05); border: 2px solid var(--lcars-orange); border-radius: 0 8px 8px 0; padding: 8px; }
        .section-title { font-family: 'Orbitron', sans-serif; font-size: 16px; color: var(--lcars-orange); text-transform: uppercase; margin-bottom: 6px; }
        .form-group { margin-bottom: 6px; }
        .form-label { display: block; font-size: 14px; color: var(--lcars-tan); text-transform: uppercase; margin-bottom: 2px; }
        .form-input { width: 100%; padding: 8px; background: var(--bg-secondary); border: 1px solid var(--lcars-tan); border-radius: 4px; color: var(--lcars-yellow); font-family: 'Antonio', sans-serif; font-size: 16px; }
        .form-input:focus { outline: none; border-color: var(--lcars-orange); }
        
        /* Préréglages sur 2 lignes avec typo plus grosse */
        .preset-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 8px; }
        .preset-card { background: rgba(255, 170, 102, 0.1); border: 2px solid var(--lcars-tan); border-radius: 8px; padding: 10px 8px; text-align: center; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; gap: 6px; min-height: 80px; }
        .preset-card:active { animation: pressDown 0.2s ease; }
        .preset-card.selected { background: rgba(255, 153, 0, 0.2); border-color: var(--lcars-orange); }
        .preset-card.custom { border-color: var(--lcars-purple); background: rgba(204, 153, 204, 0.1); }
        .preset-card.custom.selected { background: rgba(204, 153, 204, 0.2); border-color: var(--lcars-purple); }
        /* Manuel en pleine largeur */
        .preset-card.manual { grid-column: 1 / -1; flex-direction: row; justify-content: center; gap: 12px; min-height: 50px; }
        .preset-icon { font-size: 28px; line-height: 1; }
        .preset-name { font-family: 'Orbitron', sans-serif; font-size: 14px; color: var(--lcars-yellow); text-transform: uppercase; font-weight: 500; line-height: 1.2; }
        
        .steps-section { flex: 1; display: flex; flex-direction: column; }
        .steps-list { flex: 1; overflow-y: auto; margin-bottom: 8px; }
        .step-card { background: rgba(153, 153, 255, 0.1); border: 1px solid var(--lcars-blue); border-radius: 6px; margin-bottom: 6px; }
        .step-header { background: var(--lcars-blue); padding: 4px 8px; display: flex; justify-content: space-between; align-items: center; }
        .step-title { font-family: 'Orbitron', sans-serif; font-size: 12px; color: var(--bg-primary); text-transform: uppercase; }
        .step-delete { background: transparent; border: none; color: var(--bg-primary); font-size: 16px; cursor: pointer; padding: 0; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .step-delete:hover { background: rgba(0, 0, 0, 0.2); }
        .step-content { padding: 6px; display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        .step-content .form-group { margin-bottom: 4px; }
        .step-content .form-input { padding: 4px; font-size: 14px; }
        
        /* Bouton Démarrer en vert */
        .btn-large { background: var(--success); border: none; padding: 12px 24px; font-family: 'Orbitron', sans-serif; font-size: 18px; color: var(--bg-primary); text-transform: uppercase; border-radius: 8px; cursor: pointer; transition: transform 0.15s ease; font-weight: 600; }
        .btn-large:active { animation: pressDown 0.2s ease; }
        .btn-small { background: var(--lcars-tan); border: none; padding: 8px 12px; font-family: 'Orbitron', sans-serif; font-size: 14px; color: var(--bg-primary); text-transform: uppercase; border-radius: 6px; cursor: pointer; transition: transform 0.15s ease; font-weight: 500; }
        .btn-small:active { animation: pressDown 0.2s ease; }
        
        /* Events & Notes avec support clavier */
        .events-list, .history-list { flex: 1; overflow-y: auto; margin-bottom: 8px; }
        .event-item, .history-item { background: rgba(255, 153, 0, 0.05); border-left: 4px solid var(--lcars-orange); padding: 8px; margin-bottom: 4px; border-radius: 0 6px 6px 0; }
        .event-time, .history-header { font-family: 'Orbitron', sans-serif; font-size: 12px; color: var(--lcars-tan); text-transform: uppercase; }
        .event-text { color: var(--lcars-yellow); margin-top: 2px; }
        .history-title { font-family: 'Orbitron', sans-serif; font-size: 14px; color: var(--lcars-yellow); font-weight: 600; }
        .history-badge { background: var(--success); color: var(--bg-primary); padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .history-badge.failed { background: var(--danger); }
        .history-content { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin: 6px 0; }
        .history-field { display: flex; flex-direction: column; }
        .history-label { font-size: 11px; color: var(--lcars-tan); text-transform: uppercase; }
        .history-value { color: var(--lcars-yellow); font-size: 13px; }
        .history-actions { display: flex; gap: 4px; }
        
        /* Modal styles */
        .modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-secondary); border: 2px solid var(--lcars-orange); border-radius: 8px; padding: 16px; min-width: 300px; max-width: 90vw; }
        .modal-title { font-family: 'Orbitron', sans-serif; font-size: 18px; color: var(--lcars-orange); text-transform: uppercase; margin-bottom: 12px; text-align: center; }
        .modal-buttons { display: flex; gap: 8px; margin-top: 16px; justify-content: center; }
        .modal-cancel { background: var(--lcars-tan); }
        .modal-confirm { background: var(--lcars-orange); }
        
        /* Textarea pour notes avec support clavier */
        .form-textarea { width: 100%; min-height: 80px; padding: 8px; background: var(--bg-secondary); border: 1px solid var(--lcars-tan); border-radius: 4px; color: var(--lcars-yellow); font-family: 'Antonio', sans-serif; font-size: 16px; resize: vertical; }
        .form-textarea:focus { outline: none; border-color: var(--lcars-orange); }
        
        /* Alerts */
        .alert-container { position: fixed; top: 60px; right: 10px; z-index: 1001; }
        .alert { background: var(--success); color: var(--bg-primary); padding: 12px 16px; border-radius: 6px; margin-bottom: 8px; font-family: 'Orbitron', sans-serif; font-size: 14px; font-weight: 600; animation: slideIn 0.3s ease; }
        .alert.error { background: var(--danger); }
        .alert-text { display: block; }
        
        /* Stars rating */
        .stars { display: flex; gap: 4px; justify-content: center; margin: 8px 0; }
        .star { font-size: 24px; color: var(--lcars-tan); cursor: pointer; transition: color 0.2s ease; }
        .star.active { color: var(--lcars-yellow); }
        
        /* Status buttons */
        .status-buttons { display: flex; gap: 8px; margin: 8px 0; justify-content: center; }
        .status-btn { background: var(--lcars-tan); border: none; padding: 8px 16px; font-family: 'Orbitron', sans-serif; font-size: 14px; color: var(--bg-primary); text-transform: uppercase; border-radius: 6px; cursor: pointer; opacity: 0.5; transition: all 0.2s ease; }
        .status-btn.active { opacity: 1; background: var(--lcars-orange); }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <div class="header-title" id="pageTitle">Dashboard</div>
            <div class="header-status" id="headerStatus">Inactif</div>
            <button class="btn-quit" onclick="quitApp()">×</button>
        </div>
        
        <div class="main">
            <!-- Dashboard -->
            <div class="screen active" id="dashboard">
                <div class="dashboard-grid" id="dashboardContent"></div>
            </div>
            
            <!-- Create -->
            <div class="screen" id="create">
                <div class="create-content">
                    <div class="form-section">
                        <div class="section-title">Configuration</div>
                        <div class="form-group">
                            <label class="form-label">Nom du batch</label>
                            <input type="text" class="form-input" id="batchName" placeholder="Mon batch" onclick="openKeyboard(this)">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="section-title">Préréglages</div>
                        <div id="presetGrid" class="preset-grid"></div>
                        
                        <div style="display: flex; gap: 8px; align-items: center; margin-top: 8px;">
                            <input type="checkbox" id="savePreset">
                            <label for="savePreset" style="color: var(--lcars-tan); font-size: 14px;">Sauvegarder comme préréglage</label>
                            <input type="text" class="form-input" id="presetName" placeholder="Nom du préréglage" style="flex: 1;" onclick="openKeyboard(this)">
                        </div>
                    </div>
                    
                    <div class="form-section steps-section">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div class="section-title">Étapes</div>
                            <button class="btn-small" onclick="addStep()">Ajouter</button>
                        </div>
                        <div class="steps-list" id="stepsList"></div>
                    </div>
                    
                    <button class="btn-large" onclick="startBatch()" style="margin-top: auto;">Démarrer</button>
                </div>
            </div>
            
            <!-- Events -->
            <div class="screen" id="events">
                <div style="display: flex; flex-direction: column; height: 100%; gap: 8px;">
                    <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 16px;">
                        <button class="btn-large" onclick="openModal('eventModal')" style="background: var(--lcars-orange); font-size: 20px; padding: 16px 32px;">Ajouter une note</button>
                    </div>
                    <div class="events-list" id="eventsList"></div>
                </div>
            </div>
            
            <!-- History -->
            <div class="screen" id="history">
                <div style="display: flex; flex-direction: column; height: 100%; gap: 8px;">
                    <h2 style="font-family: 'Orbitron', sans-serif; color: var(--lcars-orange); font-size: 18px; text-transform: uppercase;">Historique</h2>
                    <div class="history-list" id="historyList"></div>
                </div>
            </div>
        </div>
        
        <div class="nav">
            <button class="nav-btn active" data-screen="dashboard" onclick="showScreen('dashboard')">Accueil</button>
            <button class="nav-btn" data-screen="create" onclick="showScreen('create')">Nouveau</button>
            <button class="nav-btn blue" data-screen="events" onclick="showScreen('events')">Notes</button>
            <button class="nav-btn purple" data-screen="history" onclick="showScreen('history')">Historique</button>
        </div>
    </div>
    
    <!-- Alert Container -->
    <div class="alert-container" id="alertContainer"></div>
    
    <!-- Add Event Modal -->
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <div class="modal-title">Ajouter une note</div>
            <textarea class="form-textarea" id="eventInput" placeholder="Tapez votre note ici..." onclick="openKeyboard(this)" onfocus="openKeyboard(this)" ontouchstart="openKeyboard(this)"></textarea>
            <div class="modal-buttons">
                <button class="btn-small modal-cancel" onclick="closeModal('eventModal')">Annuler</button>
                <button class="btn-small modal-confirm" onclick="addEvent()">Ajouter</button>
            </div>
        </div>
    </div>
    
    <!-- Stop Batch Modal -->
    <div class="modal" id="stopModal">
        <div class="modal-content">
            <div class="modal-title">Terminer le batch</div>
            <div style="margin: 16px 0;">
                <label class="form-label">Statut</label>
                <div class="status-buttons">
                    <button class="btn-small status-btn" id="statusOk" onclick="setStopStatus('completed')">Réussi</button>
                    <button class="btn-small status-btn" id="statusFailed" onclick="setStopStatus('failed')">Échoué</button>
                </div>
            </div>
            <div style="margin: 16px 0;">
                <label class="form-label">Évaluation</label>
                <div class="stars" id="stopStars">
                    <span class="star" onclick="setStopRating(1)">★</span>
                    <span class="star" onclick="setStopRating(2)">★</span>
                    <span class="star" onclick="setStopRating(3)">★</span>
                    <span class="star" onclick="setStopRating(4)">★</span>
                    <span class="star" onclick="setStopRating(5)">★</span>
                </div>
            </div>
            <div style="margin: 16px 0;">
                <label class="form-label">Notes</label>
                <textarea class="form-textarea" id="stopNotes" placeholder="Notes finales..." onclick="openKeyboard(this)" onfocus="openKeyboard(this)" ontouchstart="openKeyboard(this)"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn-small modal-cancel" onclick="closeModal('stopModal')">Annuler</button>
                <button class="btn-small modal-confirm" onclick="stopBatch()">Terminer</button>
            </div>
        </div>
    </div>
    
    <!-- History Detail Modal -->
    <div class="modal" id="historyDetailModal">
        <div class="modal-content">
            <div class="modal-title" id="historyDetailTitle">Détails</div>
            <div id="historyDetailContent"></div>
        </div>
    </div>
    
    <!-- Confirm Delete Modal -->
    <div class="modal" id="confirmDeleteModal">
        <div class="modal-content">
            <div class="modal-title">Confirmer</div>
            <p style="color: var(--lcars-yellow); text-align: center; margin: 16px 0;">Supprimer ce batch de l'historique ?</p>
            <div class="modal-buttons">
                <button class="btn-small modal-cancel" onclick="closeModal('confirmDeleteModal')">Annuler</button>
                <button class="btn-small modal-confirm" style="background: var(--danger);" onclick="confirmDeleteHistory()">Supprimer</button>
            </div>
        </div>
    </div>

    <script>
        let state = {}, presets = {}, selectedPreset = null, editSteps = [], stopStatus = 'completed', stopRating = 0, historyToDelete = null;
        
        function openKeyboard(element) {
            // Focus sur l'élément pour déclencher le clavier virtuel
            element.focus();
            // Pour les textarea, simuler un tap pour forcer l'ouverture du clavier
            if (element.tagName === 'TEXTAREA') {
                element.setAttribute('readonly', false);
                element.click();
                setTimeout(() => {
                    element.focus();
                    element.setSelectionRange(element.value.length, element.value.length);
                }, 100);
            }
        }
        
        function setStopStatus(status) {
            stopStatus = status;
            document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(status === 'completed' ? 'statusOk' : 'statusFailed').classList.add('active');
        }
        
        function setStopRating(rating) {
            stopRating = rating;
            updateStars();
        }
        
        function updateStars() {
            document.querySelectorAll('#stopStars .star').forEach((s, i) => {
                s.classList.toggle('active', i < stopRating);
            });
        }
        
        async function fetchState() {
            const res = await fetch('/api/state');
            state = await res.json();
            document.getElementById('headerStatus').textContent = state.batch ? `${state.mode === 'fermenting' ? 'Fermentation' : 'Déshydratation'}` : 'Inactif';
            document.getElementById('headerStatus').className = `header-status ${state.batch ? 'fermenting' : ''}`;
            renderDashboard();
        }
        
        async function fetchPresets() {
            const res = await fetch('/api/presets');
            presets = await res.json();
            renderPresets();
        }
        
        async function fetchHistory() {
            const res = await fetch('/api/history');
            const history = await res.json();
            renderHistory(history);
        }
        
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-screen="${id}"]`)?.classList.add('active');
            document.getElementById('pageTitle').textContent = {dashboard: state.batch ? 'En cours' : 'Accueil', create: 'Nouveau', events: 'Notes', history: 'Historique'}[id] || 'Protein Resequencer';
            if (id === 'history') fetchHistory();
            if (id === 'events') renderEvents();
        }
        
        function renderDashboard() {
            const c = document.getElementById('dashboardContent');
            if (!state.batch) { 
                c.innerHTML = `<div class="empty-state" style="grid-column: span 2; grid-row: span 2;">
                    <div class="empty-icon" onclick="showScreen('create')">+</div>
                    <h2 class="empty-title">Aucune fermentation</h2>
                </div>`; 
                return; 
            }
            const avg = (state.sensors.temperature.reduce((a,b)=>a+b,0)/3).toFixed(1), s = state.batch.current_step, p = state.batch.step_progress||0, e = state.batch.elapsed_hours||0;
            c.innerHTML = `<div class="panel"><div class="panel-header"><span class="panel-title">Température</span><div class="panel-indicator ${state.actuators.heater?'':'off'}"></div></div><div class="panel-content"><span class="stat-value">${avg}<span class="stat-unit">°C</span></span><div class="stat-target">Cible: ${s.temp}°C</div></div></div><div class="panel"><div class="panel-header"><span class="panel-title">Humidité</span><div class="panel-indicator ${state.actuators.humidifier?'':'off'}"></div></div><div class="panel-content"><span class="stat-value">${state.sensors.humidity.toFixed(0)}<span class="stat-unit">%</span></span><div class="stat-target">Cible: ${s.humidity}%</div></div></div><div class="panel"><div class="panel-header"><span class="panel-title">${state.batch.id}</span></div><div class="panel-content"><div class="batch-grid"><div class="batch-field"><span class="batch-label">Type</span><span class="batch-value">${state.batch.name}</span></div><div class="batch-field"><span class="batch-label">Étape</span><span class="batch-value">${state.batch.current_step_index+1}/${state.batch.steps.length}</span></div><div class="batch-field"><span class="batch-label">Phase</span><span class="batch-value">${s.name}</span></div><div class="batch-field"><span class="batch-label">Temps</span><span class="batch-value">${e}h/${s.duration}h</span></div></div><div class="progress-bar"><div class="progress-fill" style="width:${p}%"></div></div></div></div><div class="panel"><div class="panel-header"><span class="panel-title">Contrôle</span></div><div class="panel-content"><div class="actuators-grid"><div class="actuator" onclick="toggleActuator('heater')"><div class="actuator-led ${state.actuators.heater?'on':'off'}">${state.actuators.heater?'●':'○'}</div><span class="actuator-name">Chauffe</span></div><div class="actuator" onclick="toggleActuator('humidifier')"><div class="actuator-led ${state.actuators.humidifier?'on':'off'}">${state.actuators.humidifier?'●':'○'}</div><span class="actuator-name">Humid.</span></div><div class="actuator" onclick="toggleActuator('fan_internal')"><div class="actuator-led ${state.actuators.fan_internal?'on':'off'}">${state.actuators.fan_internal?'●':'○'}</div><span class="actuator-name">Ventilo</span></div><div class="actuator" onclick="toggleActuator('fan_extract')"><div class="actuator-led ${state.actuators.fan_extract?'on':'off'}">${state.actuators.fan_extract?'●':'○'}</div><span class="actuator-name">Extract.</span></div></div><div style="display:flex;gap:4px;margin-top:8px;width:100%;">${state.batch.current_step_index<state.batch.steps.length-1?'<button class="btn-small" style="flex:1" onclick="nextStep()">Étape suiv.</button>':''}<button class="btn-small" style="flex:1;background:var(--danger);" onclick="openStopModal()">Terminer</button></div></div></div>`;
        }
        
        function renderPresets() {
            const g = document.getElementById('presetGrid');
            const systemPresets = Object.entries(presets).filter(([k,p])=>p.system!==false && k !== 'manual');
            const customPresets = Object.entries(presets).filter(([k,p])=>p.system===false);
            const manualPreset = presets.manual;
            
            g.innerHTML = systemPresets.map(([k,p])=>`<div class="preset-card ${selectedPreset===k?'selected':''}" onclick="selectPreset('${k}')"><div class="preset-icon">${p.icon}</div><div class="preset-name">${p.name}</div></div>`).join('') + 
            customPresets.map(([k,p])=>`<div class="preset-card custom ${selectedPreset===k?'selected':''}" onclick="selectPreset('${k}')"><div class="preset-icon">${p.icon}</div><div class="preset-name">${p.name}</div></div>`).join('') +
            (manualPreset ? `<div class="preset-card manual ${selectedPreset==='manual'?'selected':''}" onclick="selectPreset('manual')"><div class="preset-icon">${manualPreset.icon}</div><div class="preset-name">${manualPreset.name}</div></div>` : '');
        }
        
        function selectPreset(k) { selectedPreset = k; editSteps = JSON.parse(JSON.stringify(presets[k].steps)); document.getElementById('batchName').value = presets[k].name; renderPresets(); renderSteps(); }
        function renderSteps() { document.getElementById('stepsList').innerHTML = editSteps.map((s,i)=>`<div class="step-card"><div class="step-header"><span class="step-title">Étape ${i+1}</span><button class="step-delete" onclick="deleteStep(${i})">×</button></div><div class="step-content"><div class="form-group"><label class="form-label">Nom</label><input type="text" class="form-input" value="${s.name}" onchange="editSteps[${i}].name=this.value" onclick="openKeyboard(this)"></div><div class="form-group"><label class="form-label">Temp</label><input type="number" class="form-input" value="${s.temp}" onchange="editSteps[${i}].temp=+this.value" onclick="openKeyboard(this)"></div><div class="form-group"><label class="form-label">Humid</label><input type="number" class="form-input" value="${s.humidity}" onchange="editSteps[${i}].humidity=+this.value" onclick="openKeyboard(this)"></div><div class="form-group"><label class="form-label">Durée</label><input type="number" class="form-input" value="${s.duration}" onchange="editSteps[${i}].duration=+this.value" onclick="openKeyboard(this)"></div></div></div>`).join(''); }
        function deleteStep(i) { editSteps.splice(i, 1); renderSteps(); }
        function addStep() { editSteps.push({name:'Étape',temp:30,humidity:70,duration:12,ventilation:'off'}); renderSteps(); }
        async function startBatch() {
            if (!editSteps.length) { showAlert('Erreur', 'Ajoutez une étape', true); return; }
            const name = document.getElementById('batchName').value || 'Sans nom';
            if (document.getElementById('savePreset').checked && document.getElementById('presetName').value) {
                await fetch('/api/presets/custom', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({name: document.getElementById('presetName').value, icon: presets[selectedPreset]?.icon||'⚙️', code: 'CU', steps: editSteps}) });
                fetchPresets();
            }
            const res = await fetch('/api/batch/start', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({preset: selectedPreset, name, steps: editSteps, code: presets[selectedPreset]?.code||'X'}) });
            const data = await res.json();
            if (data.success) { showAlert('Démarré', data.batch.id); fetchState(); showScreen('dashboard'); }
        }
        function openStopModal() { stopStatus='completed'; stopRating=0; updateStars(); document.getElementById('stopNotes').value=''; document.querySelectorAll('.status-btn').forEach(b=>b.classList.remove('active')); document.getElementById('statusOk').classList.add('active'); openModal('stopModal'); }
        async function stopBatch() { closeModal('stopModal'); await fetch('/api/batch/stop', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:stopStatus,rating:stopRating,notes:document.getElementById('stopNotes').value})}); showAlert('Terminé','Batch archivé'); fetchState(); }
        async function nextStep() { const res = await fetch('/api/batch/next-step',{method:'POST'}); const data = await res.json(); if(data.success){showAlert('Étape suivante',data.step.name);fetchState();} }
        async function toggleActuator(n) { await fetch(`/api/actuator/${n}`,{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'}); fetchState(); }
        async function addEvent() { const i=document.getElementById('eventInput'); if(!i.value)return; await fetch('/api/batch/event',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:i.value})}); i.value=''; closeModal('eventModal'); fetchState(); renderEvents(); }
        function renderEvents() { const l=document.getElementById('eventsList'),ev=state.events||[]; l.innerHTML=ev.length?ev.map(e=>`<div class="event-item"><span class="event-time">${new Date(e.time).toLocaleString('fr-FR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})}</span><span class="event-text">${e.text}</span></div>`).join(''):'<p style="color:var(--lcars-tan);text-align:center;padding:40px;font-size:18px;">Aucun événement</p>'; }
        function renderHistory(h) { const l=document.getElementById('historyList'); l.innerHTML=h.length?h.slice(0,20).map(b=>`<div class="history-item"><div class="history-header"><span class="history-title">${b.id} — ${b.name}</span><span class="history-badge ${b.status==='completed'?'success':'failed'}">${b.rating?'★'.repeat(b.rating):(b.status==='completed'?'OK':'✗')}</span></div><div class="history-content"><div class="history-field"><span class="history-label">Date</span><span class="history-value">${new Date(b.started_at).toLocaleDateString('fr-FR')}</span></div><div class="history-field"><span class="history-label">Durée</span><span class="history-value">${b.total_duration}h</span></div><div class="history-field"><span class="history-label">Étapes</span><span class="history-value">${b.steps?.length||0}</span></div><div class="history-field"><span class="history-label">Notes</span><span class="history-value">${(b.events||[]).length}</span></div></div><div class="history-actions"><button class="btn-small" onclick="relaunchBatch('${b.id}')">Relancer</button><button class="btn-small" style="background:var(--lcars-purple)" onclick="viewDetail('${b.id}')">Détails</button><button class="btn-small" style="background:var(--danger)" onclick="deleteHistory('${b.id}')">Suppr.</button></div></div>`).join(''):'<p style="color:var(--lcars-tan);text-align:center;padding:40px;font-size:18px;">Aucun historique</p>'; }
        async function relaunchBatch(id) { const b=await(await fetch(`/api/history/${encodeURIComponent(id)}`)).json(); if(b.steps){editSteps=JSON.parse(JSON.stringify(b.steps));document.getElementById('batchName').value=b.name;selectedPreset=b.preset;renderPresets();renderSteps();showScreen('create');showAlert('Chargé','Paramètres récupérés');} }
        async function viewDetail(id) { const b=await(await fetch(`/api/history/${encodeURIComponent(id)}`)).json(); document.getElementById('historyDetailTitle').textContent=b.id; document.getElementById('historyDetailContent').innerHTML=`<p style="color:var(--lcars-tan);font-size:16px">NOM</p><p style="color:var(--lcars-yellow);font-family:Orbitron;margin-bottom:10px;font-size:18px;">${b.name}</p><p style="color:var(--lcars-tan);font-size:16px">ÉTAPES</p>${b.steps.map((s,i)=>`<p style="color:var(--lcars-blue);font-size:16px">${i+1}. ${s.name} — ${s.temp}°C, ${s.humidity}%, ${s.duration}h</p>`).join('')}${b.notes?`<p style="color:var(--lcars-tan);font-size:16px;margin-top:10px">NOTES</p><p style="color:var(--text-light);font-size:18px">${b.notes}</p>`:''}<div class="modal-buttons"><button class="modal-cancel" onclick="closeModal('historyDetailModal')">Fermer</button><button class="modal-confirm" onclick="closeModal('historyDetailModal');relaunchBatch('${b.id}')">Relancer</button></div>`; openModal('historyDetailModal'); }
        function deleteHistory(id) { historyToDelete=id; openModal('confirmDeleteModal'); }
        async function confirmDeleteHistory() { closeModal('confirmDeleteModal'); if(historyToDelete){await fetch(`/api/history/${encodeURIComponent(historyToDelete)}`,{method:'DELETE'});showAlert('Supprimé','');fetchHistory();historyToDelete=null;} }
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showAlert(t, m, err=false) { const c=document.getElementById('alertContainer'),a=document.createElement('div');a.className='alert'+(err?' error':'');a.innerHTML=`<span class="alert-text"><strong>${t}</strong> ${m}</span>`;c.appendChild(a);setTimeout(()=>a.remove(),3000); }
        function quitApp() { if(confirm('Quitter Protein Resequencer ?')) { fetch('/api/quit', {method:'POST'}); setTimeout(()=>window.close(), 500); } }
        fetchState(); fetchPresets(); setInterval(fetchState, 5000);
    </script>
</body>
</html>
